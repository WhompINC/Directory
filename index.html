<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SDU Shield Explorer</title>
  <style>
    html, body { height:100%; margin:0; font-family: monospace; background:#1e1e1e; color:#ddd; }
    .layout { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: 40px 1fr; height:100%; }
    /* Sidebar */
    #sidebar { grid-column:1; grid-row:1/3; background:#2d2d2d; padding:10px; overflow-y:auto; }
    #sidebar h2 { margin:0 0 10px; font-size:18px; }
    #tree { list-style:none; padding:0; margin:0; }
    #tree li { display:flex; align-items:center; padding:4px; cursor:pointer; }
    #tree li.folder .icon::before { content:'üìÅ'; }
    #tree li.file .icon::before { content:'üìÑ'; }
    #tree li .icon { width:20px; text-align:center; margin-right:6px; }
    #tree li:hover { background:#3a3a3a; }
    /* Header */
    #header { grid-column:2; grid-row:1; display:flex; align-items:center; background:#333; padding:0 12px; border-bottom:1px solid #444; }
    #path { flex:1; color:#569cd6; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    #search { width:200px; margin-left:auto; padding:4px 8px; background:#222; border:1px solid #444; color:#ddd; }
    /* Viewer */
    #viewer { grid-column:2; grid-row:2; padding:12px; background:#252526; overflow:auto; }
    .item { display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #333; }
    .item .name { flex:1; color:#569cd6; cursor:pointer; }
    .item .name:hover { text-decoration:underline; }
    .item .icon { margin-right:8px; }
    .download { background:transparent; border:none; color:#0e639c; font-size:18px; cursor:pointer; }
    /* Document Content */
    #doc { white-space:pre-wrap; background:#1e1e1e; border:1px solid #444; padding:10px; min-height:200px; color:#ddd; }
  </style>
</head>
<body>
  <div class="layout">
    <nav id="sidebar">
      <h2>üìÅ Files</h2>
      <ul id="tree"></ul>
    </nav>
    <header id="header">
      <div id="path">/</div>
      <input id="search" placeholder="üîç Search...">
    </header>
    <main id="viewer">
      <div id="doc">Select a file or folder</div>
    </main>
  </div>

  <script>
    // treeData injected here by file_master.py
    // const treeData = {...};

    const mappingIcons = ext => ({ 'png':'üñºÔ∏è','jpg':'üñºÔ∏è','zip':'üóúÔ∏è','html':'üåê','c':'üíª','h':'üíª','txt':'üìÑ' }[ext]||'üìÑ');
    const tree = treeData.LOCAL;
    let currentNode = tree;
    let currentPath = [];

    const treeEl = document.getElementById('tree');
    const viewer = document.getElementById('viewer');
    const docEl = document.getElementById('doc');
    const pathDisp = document.getElementById('path');
    const searchEl = document.getElementById('search');

    function buildTree(node, parentEl, path) {
      Object.entries(node).forEach(([name, val]) => {
        const li = document.createElement('li');
        li.classList.add(val==='file'?'file':'folder');
        const icon = document.createElement('span'); icon.className='icon';
        const txt = document.createElement('span'); txt.className='name'; txt.textContent = name;
        li.append(icon, txt);
        parentEl.append(li);
        const newPath = path.concat(name);
        txt.onclick = () => navigate(newPath);
        if(val !== 'file') {
          const ul = document.createElement('ul'); ul.style.display='none'; ul.style.paddingLeft='16px';
          li.append(ul);
          li.onclick = e => { e.stopPropagation(); ul.style.display = ul.style.display==='none'?'block':'none'; };
          buildTree(val, ul, newPath);
        }
      });
    }

    function navigate(pathArr) {
      currentPath = pathArr;
      currentNode = pathArr.reduce((node, seg) => node[seg], tree);
      renderPath(); renderViewer();
    }

    function renderPath() {
      pathDisp.textContent = '/' + currentPath.join('/');
    }

    function renderViewer() {
      viewer.innerHTML = '';
      if(typeof currentNode === 'object') {
        Object.entries(currentNode).forEach(([name, val]) => {
          const div = document.createElement('div'); div.className='item';
          const icon = document.createElement('span'); icon.className='icon';
          icon.textContent = val==='file'?mappingIcons(name.split('.').pop()):'üìÅ';
          const nameEl = document.createElement('span'); nameEl.className='name'; nameEl.textContent=name;
          nameEl.onclick = () => navigate(currentPath.concat(name));
          div.append(icon, nameEl);
          if(val==='file') {
            const dl = document.createElement('button'); dl.className='download'; dl.textContent='üì•';
            dl.onclick = () => window.open(`d/${currentPath.join('/')}/${name}`);
            div.append(dl);
          }
          viewer.append(div);
        });
        docEl.style.display='none';
      } else {
        docEl.style.display='block'; docEl.textContent = 'Loading...';
        fetch(`d/${currentPath.join('/')}`)
          .then(r=>r.text()).then(txt=> docEl.textContent = txt)
          .catch(()=> docEl.textContent = 'Error loading file');
        viewer.append(docEl);
      }
    }

    searchEl.oninput = () => {
      const q = searchEl.value.toLowerCase();
      document.querySelectorAll('.name').forEach(el => {
        const show = el.textContent.toLowerCase().includes(q);
        el.parentNode.style.display = show?'flex':'none';
      });
    };

    window.onload = () => { buildTree(tree, treeEl, []); navigate([]); };
  </script>
</body>
</html>
