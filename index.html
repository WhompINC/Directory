<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SDU Shield Explorer</title>
  <style>
    html, body { height:100%; margin:0; font-family: monospace; background:#1e1e1e; color:#ddd; }
    .layout { display:flex; height:100%; }
    /* Sidebar */
    #sidebar { width:250px; background:#2d2d2d; display:flex; flex-direction:column; transition:width 0.2s; }
    #sidebar.collapsed { width:40px; }
    #sidebar header { display:flex; align-items:center; justify-content:space-between; padding:10px; background:#333; }
    #sidebar header button { background:transparent; border:none; color:#ddd; font-size:18px; cursor:pointer; transition:transform 0.2s; }
    #sidebar header button:active { transform:scale(0.9); }
    #sidebar #env-toggle { display:flex; }
    #sidebar #env-toggle button { flex:1; background:#444; border:none; color:#ddd; padding:4px; cursor:pointer; transition:background 0.2s; }
    #sidebar #env-toggle button.active { background:#0e639c; }
    #sidebar ul { flex:1; overflow:auto; list-style:none; padding:0 10px; margin:0; }
    #sidebar li { margin:4px 0; cursor:pointer; user-select:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #sidebar li.folder::before { content:"‚ñ∂ "; display:inline-block; width:1em; }
    #sidebar li.folder.expanded::before { content:"‚ñº "; }
    #sidebar li.file::before { content:"üìÑ "; }
    /* Main area */
    .main { flex:1; display:flex; flex-direction:column; }
    #controls { background:#333; padding:8px; display:flex; align-items:center; }
    #search { flex:1; padding:4px 8px; background:#222; border:1px solid #444; color:#ddd; }
    #search:active, #search:focus { border-color:#0e639c; outline:none; }
    #controls button { background:#444; border:none; color:#fff; padding:4px 8px; margin-left:8px; cursor:pointer; transition:background 0.1s; }
    #controls button:active { background:#0e639c; }
    #viewer { flex:1; padding:12px; overflow:auto; display:grid; grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); grid-gap:12px; background:#252526; }
    .item { background:#333; padding:10px; border:1px solid #444; text-align:center; cursor:pointer; transition:background 0.1s; position:relative; }
    .item:active { background:#0e639c; }
    .item .icon { font-size:32px; margin-bottom:8px; }
    .item .name { font-size:14px; word-break:break-all; }
    .download-btn { background:transparent; border:none; color:#0e639c; font-size:16px; position:absolute; bottom:4px; right:4px; cursor:pointer; }
    .download-btn:active { background:#444; }
    #doc-viewer { position:absolute; top:50px; left:50%; transform:translateX(-50%); width:80%; height:80%; background:#1e1e1e; border:1px solid #444; padding:20px; overflow:auto; display:none; z-index:100; }
    #doc-viewer pre { white-space:pre-wrap; color:#ddd; }
    #doc-close { position:absolute; top:10px; right:10px; background:transparent; border:none; color:#ddd; font-size:18px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="layout">
    <div id="sidebar">
      <header>
        <div>üìÅ Files</div>
        <button id="toggle-btn">‚ùÆ</button>
      </header>
      <div id="env-toggle">
        <button id="btn-local" class="active">LOCAL</button>
        <button id="btn-virtual">VIRTUAL</button>
      </div>
      <ul id="tree"></ul>
    </div>
    <div class="main">
      <div id="controls">
        <input id="search" placeholder="Search..." />
        <button id="search-btn">üîç</button>
        <button id="refresh">üîÑ Refresh</button>
      </div>
      <div id="viewer"></div>
    </div>
  </div>
  <div id="doc-viewer">
    <button id="doc-close">‚úñ</button>
    <pre id="doc-view"></pre>
  </div>
  <script>
    let treeData = {}, env = 'LOCAL', nav = [];
    const icons = { png:'üñºÔ∏è', jpg:'üñºÔ∏è', zip:'üóúÔ∏è', html:'üåê', c:'üíª', h:'üíª', txt:'üìÑ' };
    const treeEl = document.getElementById('tree'), viewer = document.getElementById('viewer');
    const searchEl = document.getElementById('search'), searchBtn = document.getElementById('search-btn');
    const refreshBtn = document.getElementById('refresh');
    const btnLocal = document.getElementById('btn-local'), btnVirtual = document.getElementById('btn-virtual');
    const toggleBtn = document.getElementById('toggle-btn');
    const docViewer = document.getElementById('doc-viewer'), docView = document.getElementById('doc-view'), docClose = document.getElementById('doc-close');

    toggleBtn.onclick = () => {
      document.getElementById('sidebar').classList.toggle('collapsed');
      toggleBtn.textContent = document.getElementById('sidebar').classList.contains('collapsed') ? '‚ùØ' : '‚ùÆ';
    };
    btnLocal.onclick = () => { env = 'LOCAL'; btnLocal.classList.add('active'); btnVirtual.classList.remove('active'); renderTree(); renderViewer('LOCAL'); };
    btnVirtual.onclick = () => { env = 'VIRTUAL'; btnVirtual.classList.add('active'); btnLocal.classList.remove('active'); renderTree(); renderViewer('VIRTUAL'); };

    async function loadTree() {
      try {
        const res = await fetch('file_tree.json');
        treeData = await res.json();
        renderTree();
        renderViewer('LOCAL');
      } catch {
        viewer.textContent = 'Failed to load tree';
      }
    }

    function renderTree() {
      treeEl.innerHTML = '';
      build(treeData[env], treeEl, '');
    }

    function build(node, container, path) {
      Object.entries(node).forEach(([name, val]) => {
        const full = path ? path + '/' + name : name;
        const li = document.createElement('li'); li.textContent = name;
        if (typeof val === 'object') {
          li.classList.add('folder');
          const childUl = document.createElement('ul'); childUl.style.display = 'none';
          li.appendChild(childUl);
          li.addEventListener('click', e => { e.stopPropagation(); childUl.style.display = childUl.style.display === 'none' ? 'block' : 'none'; renderViewer(full); });
          container.appendChild(li);
          build(val, childUl, full);
        } else {
          li.classList.add('file');
          li.addEventListener('click', e => { e.stopPropagation(); renderViewer(full); });
          container.appendChild(li);
        }
      });
    }

    async function renderViewer(path) {
      viewer.innerHTML = '';
      const parts = path.split('/'); let node = treeData[env]; parts.forEach(p => node = node[p]);
      if (typeof node === 'object') {
        Object.entries(node).forEach(([name, val]) => {
          const full = path + '/' + name;
          const div = document.createElement('div'); div.className = 'item';
          const ext = name.split('.').pop();
          const icon = typeof val === 'object' ? 'üìÅ' : icons[ext] || 'üìÑ';
          div.innerHTML = `<div class="icon">${icon}</div><div class="name">${name}</div>`;
          div.addEventListener('click', () => renderViewer(full));
          if (typeof val !== 'object') {
            const dl = document.createElement('button'); dl.className = 'download-btn'; dl.textContent = '‚¨áÔ∏è';
            dl.addEventListener('click', e => { e.stopPropagation(); window.open(full, '_blank'); });
            div.appendChild(dl);
          }
          viewer.appendChild(div);
        });
      } else {
        try {
          const res = await fetch(path); const text = await res.text();
          docView.textContent = text; docViewer.style.display = 'block';
        } catch {
          docView.textContent = 'Error loading file'; docViewer.style.display = 'block';
        }
      }
    }

    searchBtn.addEventListener('click', performSearch);
    searchEl.addEventListener('keydown', e => { if (e.key === 'Enter') performSearch(); });
    function performSearch() {
      const term = searchEl.value.toLowerCase();
      viewer.innerHTML = '';
      (function walk(node, prefix) {
        Object.entries(node).forEach(([name, val]) => {
          const full = prefix ? prefix + '/' + name : name;
          if (typeof val === 'object') walk(val, full);
          else if (full.toLowerCase().includes(term)) {
            const ext = name.split('.').pop(); const icon = icons[ext] || 'üìÑ';
            const div = document.createElement('div'); div.className = 'item';
            div.innerHTML = `<div class="icon">${icon}</div><div class="name">${name}</div>`;
            div.addEventListener('click', () => renderViewer(full));
            viewer.appendChild(div);
          }
        });
      })(treeData[env], '');
    }

    refreshBtn.addEventListener('click', loadTree);
    docClose.addEventListener('click', () => docViewer.style.display = 'none');
    window.onload = loadTree;
  </script>
</body>
</html>
